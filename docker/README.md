# Introduction
This docker compose project sets up a complete demo of the plugin and licence manager system. The intention is to be able to demonstrate the complete lifecycle of a licenced plugin. The demo includes the following docker containers: 

1. A word press based shopping cart for purchasing and installing licences.
A word press installation with Easy Digital Downloads, Shop Front theme and the edd-downloads-as-osgi plugins installed

2. A Sonotype Nexus maven repository to store plugins and and licence specifications

3. A Karaf container to run the licence generator which uses the licence specifications to generate licences which are published through the shopping cart

# Installation

## 1. Prerequisites
You need docker, docker-compose and maven installed in the host machine. To install on Centos 7:

[How To Install and Use Docker on CentOS 7](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-centos-7)

[How To Install and Use Docker Compose on CentOS 7 ](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-centos-7 )

[How To Install Maven ](https://maven.apache.org/install.html )


## 2. Build plugin manager project
You must first build the org.opennms.plugin.pluginmanager project. This will create a kar file containing the plugin manager which can be run as the licence generator in the demo karaf. This will also generate a maven artifact plugin which you can use to create a test licence.

```
cd  org.opennms.plugin.pluginmanager
mvn clean install
```
## 3. Build the docker project using maven.

The maven pom.xml script specifies the download of Wordpress plugins easy-digital-downloads and shop-front theme from Git so that they can be referenced from within the wordpress container. These plugins are cloned and checked out into the 'localgitrepo' folder. Note that the repos will only be cloned once on the first build. The maven build also copies the plugin manager kar into the karaf-deploy directory.
```
cd  docker
mvn clean install
```
## 4. Start the docker project using docker-compose

```
cd  docker
docker-compose up -d
```
This should bring up all the containers described in docker-compose.xml. This will take a little while particularly for Karaf and Nexus. 
The services should appear on the following urls reachable from the host machine.

Karaf Plugin Manager:
```
http://localhost:118181/featuremgr/diagnostics/feature-mgr-rest-diagnostics.html

http://localhost:18181/licencemgr/diagnostics/licence-mgr-rest-diagnostics.html

http://localhost:18181/admin/plugin-manager
```
Sonotype Nexus:
```
http://localhost:28081/nexus/  (default username: admin password: admin123)
```
Wordpress:
```
http://localhost:80
```

## 5. Configure Nexus
For the demo to run, you need to set up some repositories in nexus. These should be called:
```
osgi-plugins
osgi-plugins-snapshots
osgi-plugins-licence-specs
osgi-plugins-licence-specs-snapshots
```
You can do this manually but there is a script which uses the Nexus rest api to create these repositories. 
To run this
```
cd docker
sh sonotype-init.sh

```
log in to the nexus ui and check these are created. 

## 6. Generate a test project licence
Create a new empty project directory and open a terminal and run the command 

```
mvn archetype:generate -DarchetypeCatalog=local -DarchetypeGroupId=org.opennms.plugins \
-DarchetypeArtifactId=karaf-pluginmanager-archetype \
-DarchetypeVersion=1.1.0-SNAPSHOT \
-DgroupId=org.opennms.plugins \
-DartifactId=myproject \
-Dpackage=org.opennms.plugins.myproject.packagename
```
This will create a new test project called myproject which we now build.
```
cd myproject
mvn clean deploy
```
With any luck, this will build the plugin project and deploy the snapshot artifacts into the Nexus repository.

To check the plugin artifacts are there browse to
```
http://localhost:28081/nexus/content/repositories/osgi-plugins-snapshots/org/opennms/plugins/
```
and the licence spec at
```
http://localhost:28081/nexus/content/repositories/osgi-plugins-licence-specs-snapshots/org/opennms/plugins/myproject.licence-spec/
```
The important modules for this discussion are the licence-spec and the licence-authenticator. These contain the public and private keys used to generate and validate a licence for a particular plugin. The licence-spec is a jar which contains code to generate a licence and is used by the shopping cart. The licence-authenticator contains code to include in your plugin project. The authenticator will not run unless a valid licence generated by it's corresponding specification is installed.

On a production system, the licence specifications are important secrets and clearly not to be publicly exposed. Probably you will want to set up a completely seperate nexus repo but for now we have a separate repo on the nexus server.

The karaf container can be instructed to download the licence-spec from nexus. However for simplicity, in the demo, just copy the file 
```
myproject/licence-spec/target/myproject.licence-spec-1.0-SNAPSHOT.jar
```
into 
```
docker/karaf-deploy
```
Check that the Karaf plugin manager has picked up this jar by browsing to
```
http://localhost:18181/licencemgr/rest/v1-0/licence-pub/list
```
You should see something like
```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<licenceMetadataSpecs>
  <licenceMetadataSpecList>
    <licenceMetadataSpec>
      <productId>myproject/1.0-SNAPSHOT</productId>
      <featureRepository>mvn:org.opennms.plugins/myproject/1.0-SNAPSHOT/xml/features</featureRepository>
      <licensee></licensee>
      <licensor>OpenNMS UK</licensor>
      <startDate>2017-07-28T10:11:23.776Z</startDate>
      <duration></duration>
      <maxSizeSystemIds>5</maxSizeSystemIds>
      <systemIds>
        <systemId>REPLACE_ME_WITH_SYSTEM_ID</systemId>
      </systemIds>
      <options>
        <option>
          <description>this is the description of option 1</description>
          <name>option1</name>
          <value></value>
        </option>
      </options>
    </licenceMetadataSpec>
  </licenceMetadataSpecList>
</licenceMetadataSpecs>
```
This is the default metadata assocaited with the licence. The shopping cart can read this to create a shopping cart item. The cart sends back an enhanced metatdata spec to generate an actual licence.




