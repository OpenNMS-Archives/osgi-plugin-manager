# Introduction
This docker compose project sets up a complete demo of the plugin and licence manager system. The intention is to be able to demonstrate the complete lifecycle of a licenced plugin. The demo includes the following docker containers: 

1. A word press based shopping cart for purchasing and installing licences.
A word press installation with Easy Digital Downloads, Shop Front theme and the edd-downloads-as-osgi plugins installed

2. A Sonotype Nexus maven repository to store plugins and and licence specifications

3. A Karaf container to run the licence generator which uses the licence specifications to generate licences which are published through the shopping cart

# Installation

## 1. Prerequisites
You need docker, docker-compose and maven installed in the host machine. To install on Centos 7:

[How To Install and Use Docker on CentOS 7](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-centos-7)

[How To Install and Use Docker Compose on CentOS 7 ](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-centos-7 )

[How To Install Maven ](https://maven.apache.org/install.html )


## 2. Build plugin manager project
You must first build the org.opennms.plugin.pluginmanager project. This will create a kar file containing the plugin manager which can be run as the licence generator in the demo karaf. This will also generate a maven artifact plugin which you can use to create a test licence.

```
cd  org.opennms.plugin.pluginmanager
mvn clean install
```
## 3. Build the docker project using maven.

The maven pom.xml script specifies the download of Wordpress plugins easy-digital-downloads and shop-front theme from Git so that they can be referenced from within the wordpress container. These plugins are cloned and checked out into the 'localgitrepo' folder. Note that the repos will only be cloned once on the first build. The maven build also copies the plugin manager kar into the karaf-deploy directory.
```
cd  docker
mvn clean install
```
## 4. Start the docker project using docker-compose

```
cd  docker
docker-compose up -d
```
This should bring up all the containers described in docker-compose.xml. This will take a little while particularly for Karaf and Nexus. 
The services should appear on the following urls reachable from the host machine.

Karaf Plugin Manager:
```
http://localhost:118181/featuremgr/diagnostics/feature-mgr-rest-diagnostics.html

http://localhost:18181/licencemgr/diagnostics/licence-mgr-rest-diagnostics.html

http://localhost:18181/admin/plugin-manager
```
Sonotype Nexus:
```
http://localhost:28081/nexus/  (default username: admin password: admin123)
```
Wordpress:
```
http://localhost:80
```

## 5. Configure Nexus
For the demo to run, you need to set up some repositories in nexus. These should be called:
```
osgi-plugins
osgi-plugins-snapshots
osgi-plugins-licence-specs
osgi-plugins-licence-specs-snapshots
```
You can do this manually but there is a script which uses the Nexus rest api to create these repositories. 
To run this
```
cd docker
sh sonotype-init.sh

```
log in to the nexus ui and check these are created. 

## 6. Generate a test project licence
Create a new empty project directory and open a terminal and run the command 

```
mvn archetype:generate -DarchetypeCatalog=local -DarchetypeGroupId=org.opennms.plugins \
-DarchetypeArtifactId=karaf-pluginmanager-archetype \
-DarchetypeVersion=1.1.0-SNAPSHOT \
-DgroupId=org.opennms.plugins \
-DartifactId=myproject \
-Dpackage=org.opennms.plugins.myproject.packagename
```
This will create a new test project called myproject which we now build.
```
cd myproject
mvn clean deploy
```
With any luck, this will build the plugin project and deploy the snapshot artifacts into the Nexus repository.

To check the plugin artifacts are there browse to
```
http://localhost:28081/nexus/content/repositories/osgi-plugins-snapshots/org/opennms/plugins/
```
and the licence spec at
```
http://localhost:28081/nexus/content/repositories/osgi-plugins-licence-specs-snapshots/org/opennms/plugins/myproject.licence-spec/
```
The important modules for this discussion are the licence-spec and the licence-authenticator. These contain the public and private keys used to generate and validate a licence for a particular plugin. The licence-spec is a jar which contains code to generate a licence and is used by the shopping cart. The licence-authenticator contains code to include in your plugin project. The authenticator will not run unless a valid licence generated by it's corresponding specification is installed.

On a production system, the licence specifications are important secrets and clearly not to be publicly exposed. Probably you will want to set up a completely separate nexus repo but for now we have a separate repo on the nexus server.

The karaf container can be instructed to download the licence-spec from nexus. However for simplicity, in the demo, just copy the file 
```
myproject/licence-spec/target/myproject.licence-spec-1.0-SNAPSHOT.jar
```
into 
```
docker/karaf-deploy
```
Check that the Karaf plugin manager has picked up this jar by browsing to
```
http://localhost:18181/licencemgr/rest/v1-0/licence-pub/list
```
You should see something like
```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<licenceMetadataSpecs>
  <licenceMetadataSpecList>
    <licenceMetadataSpec>
      <productId>myproject/1.0-SNAPSHOT</productId>
      <featureRepository>mvn:org.opennms.plugins/myproject/1.0-SNAPSHOT/xml/features</featureRepository>
      <licensee></licensee>
      <licensor>OpenNMS UK</licensor>
      <startDate>2017-07-28T10:11:23.776Z</startDate>
      <duration></duration>
      <maxSizeSystemIds>5</maxSizeSystemIds>
      <systemIds>
        <systemId>REPLACE_ME_WITH_SYSTEM_ID</systemId>
      </systemIds>
      <options>
        <option>
          <description>this is the description of option 1</description>
          <name>option1</name>
          <value></value>
        </option>
      </options>
    </licenceMetadataSpec>
  </licenceMetadataSpecList>
</licenceMetadataSpecs>
```
This is the default metadata assocaited with the licence. The shopping cart can read this to create a shopping cart item. The cart sends back an enhanced metatdata spec to generate an actual licence.

Not every plugin needs a licence. The available plugins are listed here. 

```
http://localhost:18181/licencemgr/rest/v1-0/product-pub/list
```
This list can be used as a remote list describing which plugins are available for download and which need a licence.

```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<productSpecifications>
  <productSpecList>
    <productMetadata>
      <productId>myproject/1.0-SNAPSHOT</productId>
      <featureRepository>mvn:org.opennms.plugins/myproject/1.0-SNAPSHOT/xml/features</featureRepository>
      <packageingDescriptor>Not Defined</packageingDescriptor>
      <productName>myproject</productName>
      <productDescription>TODO complete product description for myproject</productDescription>
      <productUrl>http:\\opennms.co.uk</productUrl>
      <organization>OpenNMS Project</organization>
      <licenceType>See Plugin Documentation for ELUA</licenceType>
      <licenceKeyRequired>true</licenceKeyRequired>
      <systemPlugin>false</systemPlugin>
    </productMetadata>
  </productSpecList>
</productSpecifications>
```

## 7. Set up the Shopping cart
The first time you start wordpress, you will need to create a default user and install the plugins. Make sure you have used maven to install the plugins as described above. The configuration will be persisted in local host directories until you delete the folders mysql-data, wp-app and wp-data. If deleted, these will be regenerated on the next run of docker compose. 

1. log in to word press http://localhost/
The first tim you log in you will be asked to set an admin username and password.

2 Set Post permalink settings
The edd-downloads-as-osgi plugin needs the permalinks to be referenced by number. 

In the wordpress settings>Permalink (http://localhost/wp-admin/options-permalink.php)
you must choose 'Default http://localhost/wordpress/?p=123'

3. Install plugins
Navigate to dashboard>plugins>installed plugins
(http://localhost/wp-admin/plugins.php)

The following plugins should already be available but not activated. Click to activate them.
Easy Digital Downloads 
Easy Digital Downloads - Downloads As OSGi licenced bundles

4. Add Easy Digital Downloads settings
Once activated, navigate to the Easy Digital Downloads Extension settings
(http://localhost/wp-admin/edit.php?post_type=download&page=edd-settings&tab=extensions)

Set the following settings;

Licence Publisher URL : http://karaf:8181
Licence Publisher Username	admin
Licence Publisher Password  admin

Note that within the docker-compose network, the karaf server is running at karaf:8181 not localhost
and that the karaf instance has no password authentication setso the username doesnt really matter.

You can view debug messages if you click Debug OSGI Plugin. The debug code will add useful but messy debug information to each of the rendered pages - so dont use in production.

## 8. Add your first plugin item to wordpress
1. Click on downloads>add new

2. On bottom righthand under Download Settings>Download As OSGi Licence, select

This download is an OSGi module
This download is an OSGi licenced module
Enter OSGi Product Id: myproject/1.0-SNAPSHOT  (this matches the test project licence generated above)

3. Create a new My Licences page
Pages>Add New
on this page add the tag
```
[osgi_licence_list]
```
This page will allow a user to list the licences which they have purchased.


4. Create a new download 
Downloads>add new
Give the download a meaningful title e.g. 'wonderful new opennms plugin'
All of the usual EDD pricing and product information can be applied to the download. You can also add a product image or logo.
However you will not be adding an actual artefact to download as this is for purchasing a licence. 

Fill in some product information on the post and add the following word press tag. 

```
This is a great new plugin

[osgi_product_description retrieve == "always"]

```
The [osgi_product_description] tag pulls the product metadata from the myproject.licence-spec-1.0-SNAPSHOT.jar registered with the plugin manager in karaf. If you set retrieve == "always" then this metadata will be retreived every time the page is accessed. If you just use [osgi_product_description] then the data is retreived only once when the page is first created. This is probably the best setting once the product has been set up as it means the page will be rendered even if the plugin manager is down (although of course you will not be able to generate licences).

Save the page and open it. You should be able to see any content you have entered along with the product metadata in a table where tou placed the [osgi_product_description] tag. 

5. Purchase and generate a licence
Having set up a product page, you should now be able to generate a licence.
Go to the site home page and select your product from the list of plugins.
Select add to checkout and got to the checkout page and cleckout your purchase. There is no payment gateway set, so there will be an error. However we can still purchase a free licence. 
You will now be given a link to your licence page. (This will also show up on the My Licences page).
You an now enter a system id and generate a licence.

To test you licence is generated correctly, copy the licence string from the page into the 'new licences' tab of your karaf plugin manager. Click install licence and you should see the licence metadata under the licence string. 








